---
title: "Ottawa COVID Projections"
---

---
site: blogdown:::blogdown_site
title: "Ottawa COVID-19 Projections"
date: "Last updated `r format(Sys.time(), '%d %B, %Y, %X EST.')`"
output:
  html_document:
    includes:
       in_header: GA_script.html
    theme: cosmo
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
_Last updated on `r format(Sys.time(), '%d %B, %Y, %X')` EST._

La version française de ce contenu sera publiée sous peu.

Current of forecast hospital use for COVID-19 patients in the Ottawa area. Created by the team behind [ProjectBigLife.ca](https://www.projectbiglife.ca) at the Ottawa Hospital and the University of Ottawa with input and data from Ottawa Public Health.

```{r, echo=FALSE, warning=FALSE, message=FALSE}

# libraries
library(plotly)
library(tidyverse)
library(ggplot2)
library(dplyr)

# data
ott_projections <- read.csv(file.path(getwd(), "../Data/Ottawa_hospitalization_estimates_COVID.csv"))
ott_observed <- read.csv(file.path(getwd(), "../Data/Observed data/Ottawa_Observed_COVID_Hospital_Use.csv"))
peak_projections <- read.csv(file.path(getwd(), "../Data/peak_projections.csv"))
TOH_projections <- read.csv(file.path(getwd(),"../Data/TOH_projection_estimates.csv"))
TOH_observed <- read.csv(file.path(getwd(),"../Data/Observed data/TOH_Observed_Hospital_Use.csv"))

# scripts
source("../R/estimate_scripts.R")
source("../R/lag_replacement.R")
source("../R/observed_data.R")
source("../R/effective_physical_distancing.R")
source("../R/data_conversion.R")
source("../R/toh_projections.R")

# data for dashboard and figures

## Observed census
exp_census <- calc_expected_values_for_n_weeks(ott_observed, number_weeks = 3)

## Dt = doubling (or halving) time
Dt <- exp_census[[2]][[3]]

Dt_label = switch( 
  (sign(Dt) + 2),
  "halving time",
  "no growth (flat)",
  "doubling time")

more_less = switch(
  (sign(Dt) + 2),
  "Fewer",
  "About the same",
  "More"
)

## projections
peak_projections$intervention <-
  factor(peak_projections$intervention, levels = c("Current distancing effectiveness", "20% reduction in distancing", "No distancing"))

current <- peak_projections[1,2]
reduction_20 <- peak_projections[2,2]
reduction_100 <- peak_projections[3,2]

current_date <- peak_projections[1,4]
reduction_20_date <- peak_projections[2,4]
reduction_100_date <- peak_projections[3,4]

```
**NOTE:** Ottawa hospitalization data is missing from 2020-04-29 to 2020-05-04. Observed hospitalization data from The Ottawa Hospital will be used in the interim as the COVID-19 Ottawa Database is being developed by Ottawa Public Health.

# Dashboard

Data to `r format(Sys.Date()-1, '%b %d, %Y')`

### Current

**`r last(na.omit(ott_observed$observed_census_ICU_p_acute_care))`** confirmed COVID-19 patients in hospital.

Including: **`r last(na.omit(ott_observed$observed_census_acute_care))`** acute care patients. **`r last(na.omit(ott_observed$observed_census_ICU))`** ICU patients.

**`r round(effective_pd, 0)`%** physical distance effectiveness (approximate).

### Short-range forecast

**`r more_less`** patients in the following week, reflecting a current `r Dt_label` of **`r round(abs(exp_census[[2]][[3]]), 1)`** days (daily growth of `r round(100*exp_census[[4]][[3]], 2)`%).

### Long-range forecast

**`r paste(current, "to", reduction_20)`** peak patients in The Ottawa Hospital between **`r paste(current_date, "&", reduction_20_date)`**. 

## Observed Hospital census {#doubling-time}

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Ottawa Hospital data section @Warsame
exp_census[[1]]$DT1 <- exp_census[[3]][[1]]$expected_val
exp_census[[1]]$DT2 <- exp_census[[3]][[2]]$expected_val
exp_census[[1]]$DT3 <- exp_census[[3]][[3]]$expected_val

#Old depricated call
#observed_figure(exp_census, "Observed census of COVID-19 hospitalizations in Ottawa", "Census (# of patients)")

# Graph selection list
icu_call <- list(type = "observed_data", y_column = "observed_census_ICU", name = "ICU census")
acute_care <- list(type = "observed_data", y_column = "observed_census_acute_care", name = "Acute care census")
DT1 <- list(type = "doubling_time", y_column = "DT1")
DT2 <- list(type = "doubling_time", y_column = "DT2")
DT3 <- list(type = "doubling_time", y_column = "DT3")

# Plotly creation 
ottawa_hosp <-
  reworked_figure(
    xaxis = "date",
    yaxis = list(icu_call, acute_care, DT1, DT2, DT3),
    titles = c(y = "Census (# of patients)", x = "Date", title = "Observed census of COVID-19 hospitalizations in Ottawa"),
    data = exp_census[[1]]
  )

# Adding Anotations
doubling_time <- exp_census[[2]]
expected_values <- exp_census[[3]]

for (i in 1:3) {
    ottawa_hosp <-
      add_annotations(
        ottawa_hosp,
        x = ifelse(
          doubling_time[[i]] > 0,
          min(expected_values[[i]]$date, na.rm = TRUE),
          max(expected_values[[i]]$date, na.rm = TRUE)
        ),
        y = median(expected_values[[i]]$expected_val, na.rm = TRUE),
        text = ifelse(doubling_time[[i]] > 0, (
          paste("Doubling time:", "\n", as.character(round(doubling_time[[i]], 1)), "days", sep = " ")
        ), (
          paste("Halving time:", "\n", as.character(round(
            abs(doubling_time[[i]]), 1
          )), "days", sep = " ")
        )),
        xref = "x",
        yref = "y",
        showarrow = FALSE
      )
}

# Display graph
ottawa_hosp
```

Hospital census `r Dt_label` of **`r round(abs(exp_census[[2]][[3]]), 1)`** days translates to current physical distancing effectiveness of approximately **`r round(effective_pd, 0)`%**. 

> **Hospital census** is the count of patients in all Ottawa hospitals at midnight on the previous day.

> **Doubling time refers** to the time it takes for the number of hospitalized patients to double in number. 

Halving time is the time it takes to halve the number of hospitalized patients. Doubling/halving time was calculated for each 7 day period (Mon-Sun).

## Peak hospitalization projections {#peak-hosp-projections}
```{r, echo=FALSE, warning=FALSE, message=FALSE}

t<- as.tbl(peak_projections) %>% mutate(End = lag(peak_hospital_census),
                                     xpos=1:n()-0.5,
                                    Diff=End-peak_hospital_census,
                                     Percent=paste(round(Diff/End*100,0),"%")) %>%
  ggplot(aes(intervention, peak_hospital_census)) + geom_col(fill = c("#2CA02C", "#1F77B4", "#D62728")) +
  labs(title = "Projected peak hospitalization census in Ottawa by scenario", x = "Scenario",
       y = "Census (# of patients)") + geom_text(aes(label = peak_hospital_round), vjust = -0.5) +
  theme(panel.background = element_rect(fill = 'white'), plot.title = element_text(hjust = 0.5)) 

t

```

The forecast of `r signif(current, 2)` patients in hospital in `r paste(current_date)` is based on the previous weeks' physical distancing effectiveness of **`r round(effective_pd, 0)`%**.

> **Physical distancing** is the reduction in close contact between people. 

> **Physical distancing effectiveness** is the amount that people without COVID-19 stay away from people who are infectious with COVID-19, compared to the time before COVID-19 control measures. 

See [More](/more) page for more information about physical distancing effectiveness.

## Hospitalization projections {#hospitalization-projections}

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/toh_projections.R")
TOH_fun(TOH_projections, "hosp_census", title = "Projected census of COVID-19 hospitalizations at The Ottawa Hospital", y = "Census (# of patients)")
```

### Daily projections

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/toh_projections.R")
TOH_fun(TOH_projections, "hosp_admits", title = "Projected daily COVID-19 hospitalizations at The Ottawa Hospital", y = "New admissions (# of patients)")
```

## Ventilator projections {#ventilator-projections}

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/toh_projections.R")
TOH_fun(TOH_projections, "vent_census", title = "Projected census of COVID-19 ventilator use at The Ottawa Hospital", y = "Census (# of patients)")
```

### Daily projections

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/toh_projections.R")
TOH_fun(TOH_projections, "vent_admits", title = "Projected daily COVID-19 ventilator use at The Ottawa Hospital", y = "# of patients")
```
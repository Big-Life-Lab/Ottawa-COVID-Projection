---
title: "Ottawa COVID-19 Projections"
---

---
site: blogdown:::blogdown_site
title: "Ottawa COVID-19 Projections"
date: "Last updated `r format(Sys.time(), '%d %B, %Y, %X EST.')`"
output:
  html_document:
    includes:
       in_header: GA_script.html
    theme: cosmo
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
_Last updated on `r format(Sys.time(), '%d %B, %Y, %X')` EST. Updates are done Monday's and Thursday's._

La version française de ce contenu sera publiée sous peu.

Current of forecast hospital use for COVID-19 patients in the Ottawa area. Created by the team behind [ProjectBigLife.ca](https://www.projectbiglife.ca) at the Ottawa Hospital and the University of Ottawa with input and data from Ottawa Public Health.

```{r, echo=FALSE, warning=FALSE, message=FALSE}

# libraries
library(plotly)
library(tidyverse)
library(ggplot2)
library(dplyr)

# data
ott_projections <- read.csv(file.path(getwd(), "../Data/OPH_projection_estimates.csv"))
ott_observed <- read.csv(file.path(getwd(), "../Data/Observed data/Ottawa_Observed_COVID_Hospital_Use.csv"))
peak_projections <- read.csv(file.path(getwd(), "../Data/peak_projections.csv"))
TOH_projections <- read.csv(file.path(getwd(),"../Data/TOH_projection_estimates.csv"))
TOH_observed <- read.csv(file.path(getwd(),"../Data/Observed data/TOH_Observed_Hospital_Use.csv"))

# scripts
#source("../R/estimate_scripts.R")
source("../R/lag_replacement.R")
source("../R/observed_data.R")
source("../R/data_conversion.R")
source("../R/hosp_projections.R")

# data for dashboard and figures

## Observed census
exp_census <- calc_expected_values_for_n_weeks(data = ott_observed, number_weeks = 3)

## Dt = doubling (or halving) time
Dt <- exp_census[[2]][[3]]

Dt_label = switch( 
  (sign(Dt) + 2),
  "halving time",
  "no growth (flat)",
  "doubling time")

more_less = switch(
  (sign(Dt) + 2),
  "Fewer",
  "About the same",
  "More"
)

## Physical distancing calculations for previous week
# Baseline characteristics
baseline_dt <- 4
Tc <- 7 
gamma <- 1/Tc 
g_baseline <- 2^(1/baseline_dt) - 1
R_naught <- 1 + g_baseline*Tc
beta_baseline <- R_naught*gamma

# Observed characteristics for previous week
observed_dt <- as.numeric(exp_census[[2]][[3]]) 
g_observed <- 2^(1/observed_dt) - 1 
Rt <- 1 + g_observed*Tc 
beta_observed <- Rt*gamma 

# Calculating effective physical distancing
effective_pd <- (1 - ((g_observed + gamma)/beta_baseline)) * 100

## projections
peak_projections$intervention <-
  factor(peak_projections$intervention, levels = c("Current transmission", "20% increase in transmission", "Early outbreak transmission"))

# Values from peak_projections.csv
current <- peak_projections[1,2] # peak with current distancing
reduction_20 <- peak_projections[2,2] # peak with 20% decrease in distancing
reduction_100 <- peak_projections[3,2] # peak with no distancing (pre-covid distancing)

current_date <- peak_projections[1,4] # date of peak with current distancing
reduction_20_date <- peak_projections[2,4] # date of peak with 20% reduction of distancing
reduction_100_date <- peak_projections[3,4] # date of peak with no distancing


# Colors
acute_col <- "rgb(72, 137, 194)"
acute_shade <- "rgba(72, 137, 194, 0.3)"
acute_hex <- "#488AC2"

vent_col <- "rgb(23, 63, 95)"
vent_shade <- "rgba(23, 63, 95, 0.3)"

icu_col <- "rgb(60, 174, 163)"
icu_shade <- "rgba(60, 174, 163)"

reduction_col <- "rgb(243, 213, 86)"
reduction_shade <- "rgba(243, 213, 86, 0.3)"
reduction_hex <- "#F6D556"

no_dist_col <- "rgb(237, 85, 59)"
no_dist_shade <- "rgba(237, 85, 59)"
no_dist_hex <- "#ED553B"

death_col <- "rgb(0,0,0)"
death_hex <- "#000000"

```
**NOTE:** Observed hospitalization data from Ottawa Public Health is now being used as the Ottawa COVID-19 Database is now released.

# Dashboard

Data to `r format(Sys.Date()-1, '%b %d, %Y')`

### Current

**`r last(na.omit(ott_observed$observed_census_ICU_p_acute_care))`** confirmed COVID-19 patients in hospital.

Including: **`r last(na.omit(ott_observed$observed_census_acute_care))`** acute care patients. **`r last(na.omit(ott_observed$observed_census_ICU))`** ICU patients.

**`r round(effective_pd, 0)`%** physical distance effectiveness (approximate).

### Short-range forecast

**`r more_less`** patients in the following week, reflecting a current `r Dt_label` of **`r round(abs(exp_census[[2]][[3]]), 0)`** days (daily growth of `r round(100*exp_census[[4]][[3]], 0)`%).

### Long-range forecast

**`r paste(current, "to", reduction_20)`** peak patients in The Ottawa Hospital between **`r paste(current_date, "&", reduction_20_date)`**. 

## Definitions

> **Hospital census** is the count of patients in all Ottawa hospitals at midnight on the previous day.

> **Transmission** is the risk that a person becomes infected when they come in contact with a person with COVID-19. 

> **Doubling time** refers to the time it takes for the number of hospitalized patients to double in number. Conversely, **halving time** refers to the time it takes for the number of hospitalized patients to halve in number.

> **Daily growth** is the rate of change in the hospitalization from day-to-day.

> **Physical distancing** is a reduction in close contact between people. 

> **Physical distancing effectiveness** is the reduction in the transmission of COVID-19 between an infected person and someone who has never had COVID-19, compared to the beginning of the pandemic in March 2020.

> **Safe socializing** is ensuring you don't become a link in a COVID-19 transmission chain that ends in a person becoming hospitalized or dying.

> **Safe reopening** is lifting lockdown measures while ensuring a low risk of COVID-19 hospitalization and death. Safe reopening includes safe socializing, safe work and safe businesses - reopening while ensure we all ensure transmissions chains do not lead to hospitalization and death. 

See [More](/more) page for more information about the terms used.

---

## Past hospital use {#observed-census}

---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Ottawa Hospital data section @Warsame
exp_census[[1]]$DT1 <- exp_census[[3]][[1]]$expected_val
exp_census[[1]]$DT2 <- exp_census[[3]][[2]]$expected_val
exp_census[[1]]$DT3 <- exp_census[[3]][[3]]$expected_val

#Old depricated call
#observed_figure(exp_census, "Observed census of COVID-19 hospitalizations in Ottawa", "Census (# of patients)")

# Graph selection list
icu_call <- list(type = "observed_data", y_column = "observed_census_ICU", name = "ICU census", color = icu_col)
acute_care <- list(type = "observed_data", y_column = "observed_census_acute_care", name = "Acute care census", color = acute_col)
DT1 <- list(type = "doubling_time", y_column = "DT1")
DT2 <- list(type = "doubling_time", y_column = "DT2")
DT3 <- list(type = "doubling_time", y_column = "DT3")

# Plotly creation 
ottawa_hosp <-
  reworked_figure(
    xaxis = "date",
    yaxis = list(icu_call, acute_care, DT1, DT2, DT3),
    titles = c(y = "# of patients", x = "Date", title = "Observed census of COVID-19 hospitalizations of Ottawa residents"),
    data = exp_census[[1]]
  )

# Adding Annotations
doubling_time <- exp_census[[2]]
expected_values <- exp_census[[3]]

for (i in 1:3) {
    ottawa_hosp <-
      add_annotations(
        ottawa_hosp,
        x = ifelse(
          doubling_time[[i]] > 0,
          min(expected_values[[i]]$date, na.rm = TRUE),
          max(expected_values[[i]]$date, na.rm = TRUE)
        ),
        y = median(expected_values[[i]]$expected_val, na.rm = TRUE),
        text = ifelse(doubling_time[[i]] > 0, (
          paste("Doubling time:", "\n", as.character(round(doubling_time[[i]], 0)), "days", sep = " ")
        ), (
          paste("Halving time:", "\n", as.character(round(
            abs(doubling_time[[i]]), 0
          )), "days", sep = " ")
        )),
        xref = "x",
        yref = "y",
        showarrow = FALSE
      )
}

# Display graph
ottawa_hosp
```

Hospital census `r Dt_label` of **`r round(abs(exp_census[[2]][[3]]), 0)`** days translates to current physical distancing effectiveness of approximately **`r round(effective_pd, 0)`%**. 

**Note:** As per Ottawa Public Health, hospital data reflecting the past 3-5 days should be considered preliminary as data is still being received and entered for this time period. 

---

## {#observed-admits}
```{r, echo=FALSE, warning=FALSE, message=FALSE}
observed_daily_ICU_p_acute_care <- list(type = "observed_data", y_column = "observed_new_ICU_p_acute_care", name = "Reported # of patients", color = acute_col)



ICU_p_acute_care <-
  reworked_figure(
    xaxis = "date",
    yaxis = list(observed_daily_ICU_p_acute_care),
    titles = c(y = "# of patients", x = "Date", title = "Observed daily COVID-19 hospitalizations of Ottawa residents"),
    data = ott_observed
  )

ICU_p_acute_care

```

---

## Projected hospital use {#peak-hosp-projections}

---

```{r, echo=FALSE, warning=FALSE, message=FALSE}

t<- as.tbl(peak_projections) %>% mutate(End = lag(peak_hospital_census),
                                     xpos=1:n()-0.5,
                                    Diff=End-peak_hospital_census,
                                     Percent=paste(round(Diff/End*100,0),"%")) %>%
  ggplot(aes(intervention, peak_hospital_census)) + geom_col(fill = c(as.character(acute_hex), as.character(reduction_hex), as.character(no_dist_hex))) +
  labs(title = "Projected peak hospitalization census in Ottawa by scenario", x = "Scenario",
       y = "# of patients") + geom_text(aes(label = peak_hospital_round), vjust = -0.5) +
  theme(panel.background = element_rect(fill = 'white'), plot.title = element_text(hjust = 0.5)) 

t

```

The hospital census forecast of:

- `r signif(current, 2)` patients on `r paste(current_date)` is based on the previous week's growth rate of `r round(100*exp_census[[4]][[3]], 0)`%.

- `r signif(reduction_20, 2)` patients  on `r paste(reduction_20_date)` is based on a 20% increase in COVID-19 transmission. 

- `r signif(reduction_100, 2)` patients on `r paste(reduction_100_date)` is based on a return to COVID-19 transmission to the beginning of the pandemic in March 2020.

---

## {#hospitalization-projections}

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/hosp_projections.R")
hosp_fun(ott_projections, "hosp_census", title = "Projected COVID-19 hospital census in Ottawa", y = "Census (# of patients)", current_color = acute_col, current_shade = acute_shade, reduction_color = reduction_col, reduction_shade = reduction_shade, observed_name = "Observed census of patients")
```

---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/hosp_projections.R")
hosp_fun(ott_projections, "hosp_admits", title = "Projected COVID-19 daily hospital admissions in Ottawa", y = "New admissions (# of patients)", current_color = acute_col, current_shade = acute_shade, reduction_color = reduction_col, reduction_shade = reduction_shade, observed_name = "Observed # of daily admissions")
```

---

## {#ventilator-projections}

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/hosp_projections.R")
hosp_fun(ott_projections, "vent_census", title = "Projected COVID-19 patients on ventilators in Ottawa", y = "# of patients", current_color = vent_col, current_shade = vent_shade, reduction_color = reduction_col, reduction_shade = reduction_shade, observed_name = "Observed # of patients on ventilators")
```

---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/hosp_projections.R")
hosp_fun(ott_projections, "vent_admits", title = "Projected COVID-19 daily new ventilator use in Ottawa", y = "# of patients", current_color = vent_col, current_shade = vent_shade, reduction_color = reduction_col, reduction_shade = reduction_shade, observed_name = "Observed daily ventilator usage")
```

---

## Past deaths {#death-visualization}

---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
observed_daily_new_deaths <- list(type = "observed_data", y_column = "observed_new_deaths", name = "Reported # of patients", color = death_col)

new_deaths <-
  reworked_figure(
    xaxis = "date",
    yaxis = list(observed_daily_new_deaths),
    titles = c(y = "# of patients", x = "Date", title = "Observed COVID-19 daily deaths of Ottawa residents"),
    data = ott_observed
  )

new_deaths

```

---

**Note:** The number of deaths in the last 3-5 days may not reflect the actual number of COVID-19 deaths as case investigations are ongoing to determine earliest onset date.
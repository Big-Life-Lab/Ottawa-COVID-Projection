---
title: "Ottawa COVID Projections"
---

---
site: blogdown:::blogdown_site
title: "Ottawa COVID-19 Projections"
date: "Last updated `r format(Sys.time(), '%d %B, %Y, %X EST.')`"
output:
  html_document:
    includes:
       in_header: GA_script.html
    theme: cosmo
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
_Last updated on `r format(Sys.time(), '%d %B, %Y, %X')` EST._

La version française de ce contenu sera publiée sous peu.

Current of forecast hospital use for COVID-19 patients in the Ottawa area. Created by the team behind [ProjectBigLife.ca](https://www.projectbiglife.ca) at the Ottawa Hospital and the University of Ottawa with input and data from Ottawa Public Health.

```{r, echo=FALSE, warning=FALSE, message=FALSE}

# libraries
library(plotly)
library(tidyverse)
library(ggplot2)
library(dplyr)

# data
ott_projections <- read.csv(file.path(getwd(), "../Data/OPH_projection_estimates.csv"))
ott_observed <- read.csv(file.path(getwd(), "../Data/Observed data/Ottawa_Observed_COVID_Hospital_Use.csv"))
peak_projections <- read.csv(file.path(getwd(), "../Data/peak_projections.csv"))
TOH_projections <- read.csv(file.path(getwd(),"../Data/TOH_projection_estimates.csv"))
TOH_observed <- read.csv(file.path(getwd(),"../Data/Observed data/TOH_Observed_Hospital_Use.csv"))

# scripts
#source("../R/estimate_scripts.R")
source("../R/lag_replacement.R")
source("../R/observed_data.R")
source("../R/data_conversion.R")
source("../R/hosp_projections.R")

# data for dashboard and figures

## Observed census
exp_census <- calc_expected_values_for_n_weeks(data = ott_observed, number_weeks = 3)

## Dt = doubling (or halving) time
Dt <- exp_census[[2]][[3]]

Dt_label = switch( 
  (sign(Dt) + 2),
  "halving time",
  "no growth (flat)",
  "doubling time")

more_less = switch(
  (sign(Dt) + 2),
  "Fewer",
  "About the same",
  "More"
)

## Physical distancing calculations for previous week
# Baseline characteristics
baseline_dt <- 4
Tc <- 7 
gamma <- 1/Tc 
g_baseline <- 2^(1/baseline_dt) - 1
R_naught <- 1 + g_baseline*Tc
beta_baseline <- R_naught*gamma

# Observed characteristics for previous week
observed_dt <- as.numeric(exp_census[[2]][[3]]) 
g_observed <- 2^(1/observed_dt) - 1 
Rt <- 1 + g_observed*Tc 
beta_observed <- Rt*gamma 

# Calculating effective physical distancing
effective_pd <- (1 - ((g_observed + gamma)/beta_baseline)) * 100

## projections
peak_projections$intervention <-
  factor(peak_projections$intervention, levels = c("Current distancing effectiveness", "20% reduction in distancing", "No distancing"))

current <- peak_projections[1,2]
reduction_20 <- peak_projections[2,2]
reduction_100 <- peak_projections[3,2]

current_date <- peak_projections[1,4]
reduction_20_date <- peak_projections[2,4]
reduction_100_date <- peak_projections[3,4]

```
**NOTE:** Observed hospitalization data from Ottawa Public Health is now being used as the Ottawa COVID-19 Database is now released.

# Dashboard

Data to `r format(Sys.Date()-1, '%b %d, %Y')`

### Current

**`r last(na.omit(ott_observed$observed_census_ICU_p_acute_care))`** confirmed COVID-19 patients in hospital.

Including: **`r last(na.omit(ott_observed$observed_census_acute_care))`** acute care patients. **`r last(na.omit(ott_observed$observed_census_ICU))`** ICU patients.

**`r round(effective_pd, 0)`%** physical distance effectiveness (approximate).

### Short-range forecast

**`r more_less`** patients in the following week, reflecting a current `r Dt_label` of **`r round(abs(exp_census[[2]][[3]]), 0)`** days (daily growth of `r round(100*exp_census[[4]][[3]], 0)`%).

### Long-range forecast

**`r paste(current, "to", reduction_20)`** peak patients in The Ottawa Hospital between **`r paste(current_date, "&", reduction_20_date)`**. 

## Observed hospital census {#observed-census}

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Ottawa Hospital data section @Warsame
exp_census[[1]]$DT1 <- exp_census[[3]][[1]]$expected_val
exp_census[[1]]$DT2 <- exp_census[[3]][[2]]$expected_val
exp_census[[1]]$DT3 <- exp_census[[3]][[3]]$expected_val

#Old depricated call
#observed_figure(exp_census, "Observed census of COVID-19 hospitalizations in Ottawa", "Census (# of patients)")

# Graph selection list
icu_call <- list(type = "observed_data", y_column = "observed_census_ICU", name = "ICU census")
acute_care <- list(type = "observed_data", y_column = "observed_census_acute_care", name = "Acute care census")
DT1 <- list(type = "doubling_time", y_column = "DT1")
DT2 <- list(type = "doubling_time", y_column = "DT2")
DT3 <- list(type = "doubling_time", y_column = "DT3")

# Plotly creation 
ottawa_hosp <-
  reworked_figure(
    xaxis = "date",
    yaxis = list(icu_call, acute_care, DT1, DT2, DT3),
    titles = c(y = "# of patients", x = "Date", title = "Observed census of COVID-19 hospitalizations in Ottawa"),
    data = exp_census[[1]]
  )

# Adding Anotations
doubling_time <- exp_census[[2]]
expected_values <- exp_census[[3]]

for (i in 1:3) {
    ottawa_hosp <-
      add_annotations(
        ottawa_hosp,
        x = ifelse(
          doubling_time[[i]] > 0,
          min(expected_values[[i]]$date, na.rm = TRUE),
          max(expected_values[[i]]$date, na.rm = TRUE)
        ),
        y = median(expected_values[[i]]$expected_val, na.rm = TRUE),
        text = ifelse(doubling_time[[i]] > 0, (
          paste("Doubling time:", "\n", as.character(round(doubling_time[[i]], 0)), "days", sep = " ")
        ), (
          paste("Halving time:", "\n", as.character(round(
            abs(doubling_time[[i]]), 0
          )), "days", sep = " ")
        )),
        xref = "x",
        yref = "y",
        showarrow = FALSE
      )
}

# Display graph
ottawa_hosp
```

Hospital census `r Dt_label` of **`r round(abs(exp_census[[2]][[3]]), 0)`** days translates to current physical distancing effectiveness of approximately **`r round(effective_pd, 0)`%**. 

> **Hospital census** is the count of patients in all Ottawa hospitals at midnight on the previous day.

> **Doubling time refers** to the time it takes for the number of hospitalized patients to double in number. 

Halving time is the time it takes to halve the number of hospitalized patients. Doubling/halving time was calculated for each 7 day period (Mon-Sun).

## Observed daily hospital admissions {#observed-admits}
```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/covid_visualization.R")
death_visualization(data1 = NULL, data2 = ott_observed, parameter = "new_ICU_p_acute_care", title = "Observed daily COVID-19 hospitalizations in Ottawa", "# of patients", fillcolor = "orange")
```

---

## Peak hospitalization projections {#peak-hosp-projections}
```{r, echo=FALSE, warning=FALSE, message=FALSE}

t<- as.tbl(peak_projections) %>% mutate(End = lag(peak_hospital_census),
                                     xpos=1:n()-0.5,
                                    Diff=End-peak_hospital_census,
                                     Percent=paste(round(Diff/End*100,0),"%")) %>%
  ggplot(aes(intervention, peak_hospital_census)) + geom_col(fill = c("#53A2BE", "#5FAD56", "#A71D31")) +
  labs(title = "Projected peak hospitalization census in Ottawa by scenario", x = "Scenario",
       y = "# of patients") + geom_text(aes(label = peak_hospital_round), vjust = -0.5) +
  theme(panel.background = element_rect(fill = 'white'), plot.title = element_text(hjust = 0.5)) 

t

```

The forecast of `r signif(current, 2)` patients in hospital in `r paste(current_date)` is based on the previous weeks' physical distancing effectiveness of **`r round(effective_pd, 0)`%**.

> **Physical distancing** is the reduction in close contact between people. 

> **Physical distancing effectiveness** is the amount that people without COVID-19 stay away from people who are infectious with COVID-19, compared to the time before COVID-19 control measures. 

See [More](/more) page for more information about physical distancing effectiveness.

## Hospitalization projections {#hospitalization-projections}

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/hosp_projections.R")
hosp_fun(ott_projections, "hosp_census", title = "Projected census of COVID-19 patients in Ottawa", y = "Census (# of patients)")
```

---

### Daily projections

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/hosp_projections.R")
hosp_fun(ott_projections, "hosp_admits", title = "Projected daily COVID-19 hospitalizations in Ottawa", y = "New admissions (# of patients)")
```

---

## Ventilator projections {#ventilator-projections}

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/hosp_projections.R")
hosp_fun(ott_projections, "vent_census", title = "Projected # of COVID-19 patients on ventilators in Ottawa", y = "# of patients")
```

---

### Daily projections

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/hosp_projections.R")
hosp_fun(ott_projections, "vent_admits", title = "Projected daily COVID-19 ventilator use in Ottawa", y = "# of patients")
```

---

## Death visualization {#death-visualization}

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/covid_visualization.R")
death_visualization(data1 = NULL, data2 = ott_observed, parameter = "new_deaths", title = "Observed new deaths in Ottawa", "# of deaths", fillcolor = "red")
```

---

**Note:** The number of deaths in the last 3-5 days may not reflect the actual number of COVID-19 deaths as case investigations are ongoing to determine earliest onset date.
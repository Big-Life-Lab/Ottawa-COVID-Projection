---
title: "Ottawa COVID Projections"
---

---
site: blogdown:::blogdown_site
title: "Ottawa COVID-19 Projections"
date: "Last updated `r format(Sys.time(), '%d %B, %Y, %X EST.')`"
output:
  html_document:
    includes:
       in_header: GA_script.html
    theme: cosmo
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
_Last updated on `r format(Sys.time(), '%d %B, %Y, %X')` EST._

La version française de ce contenu sera publiée sous peu.

Current of forecast hospital use for COVID-19 patients in the Ottawa area. Created by the team behind [ProjectBigLife.ca](https://www.projectbiglife.ca) at the Ottawa Hospital and the University of Ottawa with input and data from Ottawa Public Health.

```{r, echo=FALSE, warning=FALSE, message=FALSE}

# libraries
library(plotly)
library(tidyverse)
library(ggplot2)
library(dplyr)

# data
ott_projections <- read.csv(file.path(getwd(), "../Data/Ottawa_hospitalization_estimates_COVID.csv"))
ott_observed <- read.csv(file.path(getwd(), "../Data/Observed data/Ottawa_Observed_COVID_Hospital_Use.csv"))
peak_projections <- read.csv(file.path(getwd(), "../Data/peak_projections.csv"))

# scripts
source("../R/estimate_scripts.R")
source("../R/lag_replacement.R")
source("../R/observed_data.R")
source("../R/effective_physical_distancing.R")
source("../R/data_conversion.R")

# data for dashboard and figures

## Observed census
exp_census <- calc_expected_values_for_n_weeks(ott_observed, number_weeks = 3)

## Dt = doubling (or halving) time
Dt <- exp_census[[2]][[3]]

Dt_label = switch( 
  (sign(Dt) + 2),
  "halving time",
  "no growth (flat)",
  "doubling time")

more_less = switch(
  (sign(Dt) + 2),
  "Fewer",
  "About the same",
  "More"
)

## projections
peak_projections$intervention <-
  factor(peak_projections$intervention, levels = c("No prevention & control", "50% physical distancing", "Current distancing effectiveness"))

no_intervention <- peak_projections[1,2]
intervention_50 <- peak_projections[2,2]
current_intervention <- peak_projections[3,2]

no_intervention_date <- peak_projections[1,4]
intervention_50_date <- peak_projections[2,4]
current_intervention_date <- peak_projections[3,4]

```

# Dashboard

Data to `r format(Sys.Date()-1, '%b %d, %Y')`

### Current

**`r last(na.omit(ott_observed$observed_census_ICU_p_acute_care))`** confirmed COVID-19 patients in hospital.

Including: **`r last(na.omit(ott_observed$observed_census_acute_care))`** acute care patients. **`r last(na.omit(ott_observed$observed_census_ICU))`** ICU patients.

**`r round(effective_pd, 0)`%** physical distance effectiveness (approximate), resulting in a **`r round(((no_intervention - current_intervention)/no_intervention*100), 0)`%** reduction in peak hospitalizations from no prevention & control.

### Short-range forecast

**`r more_less`** patients in hospital the this week, reflecting a current `r Dt_label` of **`r round(abs(exp_census[[2]][[3]]), 1)`** days (daily growth of `r round(100*exp_census[[4]][[3]], 2)`%).

### Long-range forecast

**`r paste(current_intervention, "to", intervention_50)`** peak patients in hospital between **`r paste(current_intervention_date, "&", intervention_50_date)`**. 


## Observed Hospital census {#doubling-time}

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/observed_data.R")
tmp <- figure_input_creation_line_listing(data = outbreak_LL_institutions, sort_date_column = "Accurate Episode Date", strata = list("Exposure Setting Type Desc" = c("RH","LTCH", "Group Home"), "Exposure Setting Comments" = c("FACILITY WIDE")))
test <- data_column_standardisation(tmp, "Exposure Setting Type Desc","Accurate Episode Date","observed_new")

observed_figure(exp_census, "Observed census of COVID-19 hospitalizations in Ottawa", "Census (# of patients)")

DT_TEST_DATA <- exp_census[[1]]
DT_TEST_DATA$DT1 <- exp_census[[3]][[1]]$expected_val
DT_TEST_DATA$DT2 <- exp_census[[3]][[2]]$expected_val
DT_TEST_DATA$DT3 <- exp_census[[3]][[3]]$expected_val

icu_call <- list(type = "observed_data", y_column = "observed_census_ICU", name = "ICU census")
acute_care <- list(type = "observed_data", y_column = "observed_census_acute_care", name = "Acute care census")
DT1 <- list(type = "doubling_time", y_column = "DT1")
DT2 <- list(type = "doubling_time", y_column = "DT2")
DT3 <- list(type = "doubling_time", y_column = "DT3")

ottawa_hosp <-
  reworked_figure(
    xaxis = "date",
    yaxis = list(icu_call, acute_care, DT1, DT2, DT3),
    titles = c(y = "Census (# of patients)", x = "Date", title = "Observed census of COVID-19 hospitalizations in Ottawa"),
    data = DT_TEST_DATA
  )

reworked_figure(
  xaxis = "Date",
  yaxis = list(
    list(
      type = "observed_data",
      y_column = "observed_new_RH",
      name = "RH"
    ),
    list(
      type = "observed_data",
      y_column = "observed_new_LTCH",
      name = "LTCH"
    )
  ),
  titles = c(y = "Daily Observed cases", x = "Date", title = "YEEE"),
  data = test
)

doubling_time <- exp_census[[2]]
expected_values <- exp_census[[3]]

for (i in 1:3) {
    ottawa_hosp <-
      add_annotations(
        ottawa_hosp,
        x = ifelse(
          doubling_time[[i]] > 0,
          min(expected_values[[i]]$date, na.rm = TRUE),
          max(expected_values[[i]]$date, na.rm = TRUE)
        ),
        y = median(expected_values[[i]]$expected_val, na.rm = TRUE),
        text = ifelse(doubling_time[[i]] > 0, (
          paste("Doubling time:", "\n", as.character(round(doubling_time[[i]], 1)), "days", sep = " ")
        ), (
          paste("Halving time:", "\n", as.character(round(
            abs(doubling_time[[i]]), 1
          )), "days", sep = " ")
        )),
        xref = "x",
        yref = "y",
        showarrow = FALSE
      )
}
ottawa_hosp
```

Hospital census `r Dt_label` of **`r round(abs(exp_census[[2]][[3]]), 1)`** days translates to current physical distancing effectiveness of approximately **`r round(effective_pd, 0)`%**. 

> **Hospital census** is the count of patients in all Ottawa hospitals at midnight on the previous day.

> **Doubling time refers** to the time it takes for the number of hospitalized patients to double in number. 

Halving time is the time it takes to halve the number of hospitalized patients. Doubling/halving time was calculated for each 7 day period (Mon-Sun).

## Peak hospitalization projections {#peak-hosp-projections}
```{r, echo=FALSE, warning=FALSE, message=FALSE}

t<- as.tbl(peak_projections) %>% mutate(End = lag(peak_hospital_census),
                                     xpos=1:n()-0.5,
                                    Diff=End-peak_hospital_census,
                                     Percent=paste(round(Diff/End*100,0),"%")) %>%
  ggplot(aes(intervention, peak_hospital_census)) + geom_col(fill = c("#D62728", "#1F77B4", "#2CA02C")) +
  labs(title = "Projected peak hospitalization census in Ottawa by scenario", x = "Scenario",
       y = "Census (# of patients)") + geom_text(aes(label = peak_hospital_round), vjust = -0.5) +
  theme(panel.background = element_rect(fill = 'white'), plot.title = element_text(hjust = 0.5)) 

t

```

The forecast of `r round(current_intervention, -1)` patients in hospital in `r paste(current_intervention_date)` is based on the previous weeks' physical distancing effectiveness of **`r round(effective_pd, 0)`%**.  `r round(effective_pd, 0)`% physical distancing effectiveness will result in an estimated `r round(((no_intervention - current_intervention)/no_intervention*100), 0)`% reduction in peak hospitalizations compared to no prevention & control.

> **Physical distancing** is the reduction in close contact between people. 

> **Physical distancing effectiveness** is the amount that people without COVID-19 stay away from people who are infectious with COVID-19, compared to the time before COVID-19 control measures. 

A further explanation of effective physical distancing will be added to the [More](/more) page soon.

## Acute care hospitalization projections {#acute-care-projections}

<!--See [here](/model#parameters) for all input parameters. -->

### Census projections

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/covid_visualization.R")
hosp_visualization(ott_projections, ott_observed, "census_acute_care", title = "Projected census of acute care COVID-19 hospitalizations in Ottawa", y_label = "Census (# of patients)", annote = TRUE)
```

### Daily projections

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/covid_visualization.R")
hosp_visualization(ott_projections, ott_observed, "new_acute_care", title = "Projected daily acute care COVID-19 hospitalizations in Ottawa", y_label = "New admissions (# of patients)")
```

## ICU projections {#icu-projections}

### Census projections

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/covid_visualization.R")
hosp_visualization(ott_projections, ott_observed, "census_ICU", title = "Projected census of COVID-19 ICU hospitalizations in Ottawa", y_label = "Census (# of patients)")
```

### Daily projections

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/covid_visualization.R")
hosp_visualization(ott_projections, ott_observed, "new_ICU", title = "Projected daily COVID-19 ICU hospitalizations in Ottawa", y_label = "New admissions (# of patients)")
```

## Ventilator projections {#ventilator-projections}

### Census projections

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/covid_visualization.R")
hosp_visualization(ott_projections, ott_observed, "census_vents", title = "Projected census of COVID-19 ventilator use in Ottawa", y_label = "Census (# of patients)")
```

### Daily projections

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/covid_visualization.R")
hosp_visualization(ott_projections, ott_observed, "new_vents", title = "Projected daily COVID-19 ventilator use in Ottawa", y_label = "Newly ventilated (# of patients)")
```

## Death projections {#deaths}

Death projections were made using existing data from Ottawa Public Health and probability data from [Tuite, Fisman, et al.](https://www.medrxiv.org/content/10.1101/2020.03.24.20042705v1) These projections assume all hospital deaths are in the ICU. Model parameters are [here](/model#parameters). 

Only deaths for hospital patients are included in the projections. Long-term care (LTC, also known as nursing homes) and retirement homes are not included in the projections. As of April 3, 2020, 40 to 60% of COVID-19 related deaths occurred in residents of LTC or retirement homes. Many residents in LTC and retirement homes are in their last years of life and have advanced directives saying they (the resident) do not want advanced life support or transfer to the hospital if they have a life threatening illness. The observed deaths, however, **include deaths that occurred outside the hospital in either LTC facilities or the community.**

### Cumulative deaths in hospital

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/covid_visualization.R")
death_visualization(ott_projections, ott_observed, "cumulative_deaths", title = "Projected cumulative number of COVID-19 hospital deaths in Ottawa", y_label = "Deaths")
```

### Daily projections

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/covid_visualization.R")
death_visualization(ott_projections, ott_observed, "new_deaths", title = "Projected number of COVID-19 daily hospital deaths in Ottawa", y_label = "Deaths")
```

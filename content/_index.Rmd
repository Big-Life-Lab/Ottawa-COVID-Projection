---
title: "Ottawa COVID Projections"
---

---
site: blogdown:::blogdown_site
title: "Ottawa COVID-19 Projections"
date: "Last updated `r format(Sys.time(), '%d %B, %Y, %X EST.')`"
output:
  html_document:
    includes:
       in_header: GA_script.html
    theme: cosmo
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
_Last updated on `r format(Sys.time(), '%d %B, %Y, %X')` EST._

La version française de ce contenu sera publiée sous peu.

Current of forecast hospital use for COVID-19 patients in the Ottawa area. Created by the team behind [ProjectBigLife.ca](https://www.projectbiglife.ca) at the Ottawa Hospital and the University of Ottawa with input and data from Ottawa Public Health.

```{r, echo=FALSE, warning=FALSE, message=FALSE}

# libraries
library(plotly)
library(tidyverse)
library(ggplot2)
library(dplyr)

# data
ott_projections <- read.csv(file.path(getwd(), "../Data/Ottawa_hospitalization_estimates_COVID.csv"))
ott_observed <- read.csv(file.path(getwd(), "../Data/Observed data/Ottawa_Observed_COVID_Hospital_Use.csv"))
peak_projections <- read.csv(file.path(getwd(), "../Data/peak_projections.csv"))

# scripts
source("../R/estimate_scripts.R")
source("../R/lag_replacement.R")
source("../R/observed_data.R")
source("../R/effective_physical_distancing.R")

# data for dashboard and figures

## Observed census
exp_census <- calc_expected_values_for_n_weeks(ott_observed, number_weeks = 3)

## Dt = doubling (or halving) time
Dt <- exp_census[[2]][[3]]

Dt_label = switch( 
  (sign(Dt) + 2),
  "halving time",
  "no growth (flat)",
  "doubling time")

more_less = switch(
  (sign(Dt) + 2),
  "Less",
  "About the same",
  "More"
)

## projections
peak_projections$intervention <-
  factor(peak_projections$intervention, levels = c("No prevention & control", "Current distancing effectiveness", "70% physical distancing"))

no_intervention <- peak_projections[1,2]
current_intervention <- peak_projections[2,2]
intervention_70 <- peak_projections[3,2]

no_intervention_date <- peak_projections[1,4]
current_intervention_date <- peak_projections[2,4]
intervention_70_date <- peak_projections[3,4]

```

# Dashboard

As of `r format(Sys.Date(), '%b %d, %Y')`:

### Current

**`r last(na.omit(ott_observed$observed_census_ICU_p_acute_care))`** confirmed COVID-19 patient in hospital.

Including: **`r last(na.omit(ott_observed$observed_census_acute_care))`** acute care patients. **`r last(na.omit(ott_observed$observed_census_ICU))`** ICU patients.

**`r round(effective_pd, 0)`%** physical distance effectiveness (approximate), resulting in a **`r round(((no_intervention - current_intervention)/no_intervention*100), 0)`%** reduction in peak hospitalizations from no prevention & control.

### Short-range forecast

**`r more_less`** patients in hospital the following week, reflecting a current `r Dt_label` of **`r round(abs(exp_census[[2]][[3]]), 1)`** days (daily growth of `r round(exp_census[[4]][[3]], 4)`%).

### Long-range forecast

**`r paste(intervention_70, "to", current_intervention)`** peak patients in hospital between **`r paste(intervention_70_date, "&", current_intervention_date)`**. 


## Observed Hospital census {#doubling-time}

```{r, echo=FALSE, warning=FALSE, message=FALSE}

observed_figure(exp_census, "Observed census of COVID-19 hospitalizations in Ottawa", "Census (# of patients)")
```

- Hospital census `r Dt_label` of **`r round(abs(exp_census[[2]][[3]]), 1)`** days translates to current physical distancing effectiveness of approximately `r round(effective_pd, 0)`%. See More.

> **Hospital census** is the count of patients in all Ottawa hospitals at midnight on the previous day.

> **Doubling time refers** is time it takes for the number of hospitalized patients to double in number. 

In the figure, doubling time was calculated for each 7 day period (Mon-Sun). Halving time is the time it takes to half the number of hospitalized patients.

## Peak hospitalization projections {#peak-hosp-projections}
```{r, echo=FALSE, warning=FALSE, message=FALSE}

t<- as.tbl(peak_projections) %>% mutate(End = lag(peak_hospital_census),
                                     xpos=1:n()-0.5,
                                    Diff=End-peak_hospital_census,
                                     Percent=paste(round(Diff/End*100,0),"%")) %>%
  ggplot(aes(intervention, peak_hospital_census)) + geom_col(fill = c("#D62728", "#1F77B4", "#2CA02C")) +
  labs(title = "Projected peak hospitalization census in Ottawa by scenario", x = "Scenario",
       y = "Census (# of patients)") + geom_text(aes(label = peak_hospital_round), vjust = -0.5) +
  theme(panel.background = element_rect(fill = 'white'), plot.title = element_text(hjust = 0.5)) 

t

```

Forecast of:

- `r round(current_intervention, -1)` patients in `r paste(current_intervention_date)`, based on current physical distancing effectiveness, or a `r round(((no_intervention - intervention_70)/no_intervention*100), 0)`% reduction in peak hospitalizations from no prevention & control.

> **Hospital census doubling time of `r round(exp_census[[2]][[3]], 1)` days translates to an effective physical distancing of approximately `r round(effective_pd, 0)`%.** 

> **Physical distancing** is the reduction in close contact between people. 

> **Physical distancing effectiveness** is the amount that people without COVID-19 stay away from people who are infectious with COVID-19, compared to the time before COVID-19 control measures. 

A further explanation of effective physical distancing will be added to the [More](/more) page soon.

## Acute care hospitalization projections {#acute-care-projections}

See [here](/model#parameters) for all input parameters.

### Census projections

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/covid_visualization.R")
hosp_visualization(ott_projections, ott_observed, "census_acute_care", title = "Projected census of acute care COVID-19 hospitalizations in Ottawa", y_label = "Census (# of patients)", annote = TRUE)
```

### Daily projections

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/covid_visualization.R")
hosp_visualization(ott_projections, ott_observed, "new_acute_care", title = "Projected daily acute care COVID-19 hospitalizations in Ottawa", y_label = "New admissions (# of patients)")
```

## ICU projections {#icu-projections}

### Census projections

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/covid_visualization.R")
hosp_visualization(ott_projections, ott_observed, "census_ICU", title = "Projected census of COVID-19 ICU hospitalizations in Ottawa", y_label = "Census (# of patients)")
```

### Daily projections

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/covid_visualization.R")
hosp_visualization(ott_projections, ott_observed, "new_ICU", title = "Projected daily COVID-19 ICU hospitalizations in Ottawa", y_label = "New admissions (# of patients)")
```

## Ventilator projections {#ventilator-projections}

### Census projections

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/covid_visualization.R")
hosp_visualization(ott_projections, ott_observed, "census_vents", title = "Projected census of COVID-19 ventilator use in Ottawa", y_label = "Census (# of patients)")
```

### Daily projections

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/covid_visualization.R")
hosp_visualization(ott_projections, ott_observed, "new_vents", title = "Projected daily COVID-19 ventilator use in Ottawa", y_label = "Newly ventilated (# of patients)")
```

## Death projections {#deaths}

Death projections were made using existing data from Ottawa Public Health and probability data from [Tuite, Fisman, et al.](https://www.medrxiv.org/content/10.1101/2020.03.24.20042705v1) These projections assume all hospital deaths are in the ICU. Model parameters are [here](/model#parameters). 

Only deaths for hospital patients are included in the projections. Long-term care (LTC, also known as nursing homes) and retirement homes are not included in the projections. As of April 3, 2020, 40 to 60% of COVID-19 related deaths occurred in residents of LTC or retirement homes. Many residents in LTC and retirement homes are in their last years of life and have advanced directives saying they (the resident) do not want advanced life support or transfer to the hospital if they have a life threatening illness. 

### Cumulative deaths in hospital

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/covid_visualization.R")
death_visualization(ott_projections, ott_observed, "cumulative_deaths", title = "Projected cumulative number of COVID-19 hospital deaths in Ottawa", y_label = "Deaths")
```

### Daily projections

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../R/covid_visualization.R")
death_visualization(ott_projections, ott_observed, "new_deaths", title = "Projected number of COVID-19 daily hospital deaths in Ottawa", y_label = "Deaths")
```

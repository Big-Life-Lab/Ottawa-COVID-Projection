---
title: "Ottawa COVID-19 Case Projections"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# libraries
library(plotly)
library(tidyverse)
library(jsonlite)
library(ggplot2)
library(dplyr)
library(tidyr)
library(lubridate)
library(stats)
library(covidseir)

# scripts
source("../../R/lag_replacement.R")
source("../../R/observed_data.R")
source("../../R/data_conversion.R")
source("../../R/hosp_projections.R")
source("../../R/open_ottawa_scripts.R")

# Pull JSON objects from OpenOttawa
ottawa_case_data <-
  fromJSON("https://opendata.arcgis.com/datasets/6bfe7832017546e5b30c5cc6a201091b_0/FeatureServer/0/query?where=1%3D1&outFields=Cumulative_Active_Cases_by_Episode_Date,7-day_Average_of_Newly_Reported_cases_by_Reported_Date,Daily_Cases_Linked_to_a_Community_Outbreak_by_Episode_Date,Daily_Cases_Not_Linked_to_an_Outbreak_ie_Sporadic_Cases_by_Episode_Date,Daily_Cases_Linked_to_an_Institutional_Outbreak_by_Episode_Date,Cumulative_Deaths_by_Date_of_Death,_Date,Daily_Cases_by_Reported_Date,Daily_Cases_by_Episode_Date,Cases_Newly_Admitted_to_Hospital,Cases_Currently_in_Hospital,Cases_Currently_in_ICU&outSR=4326&f=json")
ottawa_test_data <-
  fromJSON("https://opendata.arcgis.com/datasets/26c902bf1da44d3d90b099392b544b81_0/FeatureServer/0/query?where=1%3D1&outFields=_Date,Number_of_Tests,Daily_%_Positivity&outSR=4326&f=json")

# data
ott_observed_covid <- data_creation(ottawa_case_data, ottawa_test_data)[["data"]]
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Set up SEIR model
## Set up sampling fractions
samp_frac <- c(rep(0.14, 13), rep(0.21, 38))
samp_frac <- c(samp_frac, rep(0.37, nrow(ott_observed_covid) - length(samp_frac)))

## Set up contact rate breakpoints
f_seg <- c(0, rep(1, nrow(ott_observed_covid) - 1))
day_new_f <- which(ott_observed_covid$date == ymd("2020-05-01"))
f_seg[seq(day_new_f, length(f_seg))] <- 2
day_ch <- which(ott_observed_covid$date == ymd("2020-06-01"))
f_seg[seq(day_ch, length(f_seg))] <- 3
```

## Observed case data

Data to `r as.character(tail(ott_observed_covid$date, n=1))`

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Fit SEIR model of observed new cases in Ottawa
fit <- fit_seir(
  daily_cases = ott_observed_covid$observed_new_cases,
  samp_frac_fixed = samp_frac, 
  f_seg = f_seg,
  i0_prior = c(log(8), 1),
  e_prior = c(0.8, 0.05),
  start_decline_prior = c(log(15), 0.1),
  end_decline_prior = c(log(22), 0.1),
  f_prior = cbind(c(0.4, 0.5, 0.6), c(0.2, 0.2, 0.2)),
  R0_prior = c(log(2.6), 0.2),
  N_pop = 1049486, # Ottawa population
  iter = 500, # number of posterior samples
  fit_type = "optimizing" # for speed only
)

# Visualize model fit
proj <- project_seir(fit, iter = 1:50)
tidy_proj <- tidy_seir(proj, resample_y_rep = 20)
first_day <- min(ott_observed_covid$date)
last_day <- 300 # how many days to create dates for
lut <- tibble(
  day = seq_len(last_day),
  date = seq(first_day, first_day + length(day) - 1, by = "1 day")
)
tidy_proj <- left_join(tidy_proj, lut, by = "day")
plot_projection(tidy_proj, obs_dat = ott_observed_covid,
  value_column = "observed_new_cases", date_column = "date")
```

## Projected case data
```{r, echo=FALSE, warning=FALSE, message=FALSE}
days_project <- 60
day_start_reduction <- 50
proj2 <- project_seir(
  fit,
  iter = 1:50,
  forecast_days = days_project,
  f_fixed_start = max(fit$days) + day_start_reduction,
  f_multi = rep(0.67, days_project - day_start_reduction + 1),
  f_multi_seg = 3 # which f segment to use
)
tidy_proj2 <- tidy_seir(proj2, resample_y_rep = 30)
tidy_proj2 <- left_join(tidy_proj2, lut, by = "day")
plot_projection(tidy_proj2, obs_dat = ott_observed_covid,
  value_column = "observed_new_cases", date_column = "date")
```
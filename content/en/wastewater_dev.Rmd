---
title: "Ottawa covid-19 wastewater surveillance (development page)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# libraries
library(plotly)
library(tidyverse)
library(jsonlite)
library(ggplot2)
library(dplyr)
library(tidyr)
library(lubridate)
library(stats)
library(zoo)
library(stringr)

# scripts
source("../../R/lag_replacement.R")
source("../../R/observed_data.R")
source("../../R/data_conversion.R")
source("../../R/hosp_projections.R")
source("../../R/open_ottawa_scripts.R")
source("../../R/wastewater.R")

# data
ott_observed_covid <- read.csv(file.path(getwd(), "../../Data/Observed data/OPH_Observed_COVID_Data.csv")) %>%
  mutate(date = as.Date(date))
ott_observed_waste <- read.csv("https://raw.githubusercontent.com/Big-Life-Lab/covid-19-wastewater/main/data/wastewater_virus.csv")
ott_long_ww_data <- read.csv("https://raw.githubusercontent.com/Big-Life-Lab/covid-19-wastewater/main/data/wwMeasure.csv")

ott_b117_data <- ott_observed_waste %>%
  mutate(sampleDate = as.Date(sampleDate)) %>%
  filter(detectB117 == TRUE)

# functions to integrate waste & covid data together
waste_clean <- wastewater_prep(ott_observed_waste)
ott_covid_waste <- merge_data(ott_observed_covid, waste_clean) %>%
    filter(date >= "2020-06-02")

variant_data <- ww_long_prep(ott_long_ww_data) %>%
  select(date, aggregation, varB117) %>%
  filter(!is.na(varB117)) %>%
  spread(aggregation, varB117) %>%
  rename(propB117 = "single") %>%
  mutate(propB117 = propB117*100,
         sd = sd*100) %>%
  filter(!is.na(sd))

variant_non_detect <- ww_long_prep(ott_long_ww_data) %>%
  select(date, aggregation, varB117) %>%
  filter(!is.na(varB117)) %>%
  spread(aggregation, varB117) %>%
  rename(propB117_detect = "single") %>%
  select(date, propB117_detect) %>%
  filter(propB117_detect == 0) %>%
  full_join(variant_data, by = "date")

# Colours
case_col <- "rgb(0, 128, 128)"
case_shade <- "rgba(0, 128, 128, 0.2)"
n1_col <- "rgb(23, 63, 95)"
n2_col <- "rgb(60, 174, 163)"
n1_n2_col <- "rgb(237, 85, 59)"
rolling_avg_col <- "rgb(226, 127, 88)"
smooth_col <- "rgb(34, 140, 34)"
red <- "rgb(255,0,0)"
red_shade <- "rgba(255, 0, 0, 0.2)"
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Initialize calls for each parameter
new_case_call <- list(type = "observed_data", y_column = "observed_new_cases", name = "Daily reported new cases", short_name = "Daily cases", color = case_col)

new_case_5_day_call <- list(type = "observed_data", y_column = "observed_new_cases_5_day", name = "5-day midpoint mean in \nreported new cases \n(by reporting date)", short_name = "New cases\n(reported date)", color = case_col, opacity = 0.15)

new_case_10_day_call <- list(type = "observed_data", y_column = "observed_new_cases_10_day", name = "10-day midpoint mean in \nreported new cases \n(by reporting date)", short_name = "New cases\n(reported date)", color = case_col, opacity = 0.15)

new_case_7_day_call <- list(type = "observed_data", y_column = "observed_new_cases_7_day", name = "7-day midpoint mean in \nreported new cases \n(by reporting date)", short_name = "New cases\n(reported date)", color = case_col, opacity = 0.15)

new_episode_5_day_call <- list(type = "observed_data", y_column = "observed_new_episodes_5_day", name = "5-day mean in \nreported new cases \n(by episode date)", short_name = "New cases\n(episode date)", color = case_col, opacity = 0.15)

new_episode_10_day_call <- list(type = "observed_data", y_column = "observed_new_episodes_10_day", name = "10-day mean in \nreported new cases \n(by episode date)", short_name = "New cases\n(episode date)", color = case_col, opacity = 0.15)

new_episode_7_day_call <- list(type = "observed_data", y_column = "observed_new_episodes_7_day", name = "7-day mean in \nreported new cases \n(by episode date)", short_name = "New cases\n(episode date)", color = case_col, opacity = 0.15)

new_community_case_5_day_call <- list(type = "observed_data", y_column = "observed_new_community_cases_5_day", name = "5-day mean \nin reported new community cases", color = case_col, opacity = 0.15)

new_community_case_10_day_call <- list(type = "observed_data", y_column = "observed_new_community_cases_7_day", name = "10-day mean \nin reported new community cases", color = case_col, opacity = 0.15)

new_community_case_7_day_call <- list(type = "observed_data", y_column = "observed_new_community_cases_10_day", name = "7 day mean \nin reported new community cases", color = case_col, opacity = 0.15)

hosp_call <- list(type = "observed_data", y_column = "observed_census_ICU_p_acute_care", name = "Hospital census", short_name = "Hosp census", color = case_col, opacity = 0.15)

pct_positivity_call_7_day <- list(type = "observed_data", y_column = "pct_positivity_7_day", name = "7-day mean \npercent positivity rate", short_name = "% positivity", color = case_col, opacity = 0.15)

active_case_call <- list(type = "observed_data", y_column = "observed_active_cases", name = "Active cases", short_name = "Active cases", color = case_col, opacity = 0.15)

active_case_5_day_call <- list(type = "observed_data", y_column = "observed_active_cases_5_day", name = "5-day mean \nin active cases", color = case_col, opacity = 0.15)

active_case_7_day_call <- list(type = "observed_data", y_column = "observed_active_cases_7_day", name = "7-day mean \nin active cases", short_name = "Active cases", color = case_col, opacity = 0.15)

active_case_10_day_call <- list(type = "observed_data", y_column = "observed_active_cases_10_day", name = "10-day mean \nin active cases", color = case_col, opacity = 0.15)

n1_call <- list(type = "signal_data", y_column = "N1", name = "N1 RNA signal", color = n1_col, yaxis = "y2") 

n2_call <- list(type = "signal_data", y_column = "N2", name = "N2 RNA signal", color = n2_col, yaxis = "y2")

n1_n2_call <- list(type = "avg_data", y_column = "N1_N2_avg", name = "Avg. viral signal", short_name = "viral signal", color = n1_n2_col, yaxis = "y2", opacity = 0.15)

n1_n2_10_day_call <- list(type = "avg_data", y_column = "N1_N2_10_day", name = "10-day midpoint mean viral signal", short_name = "10-day", color = rolling_avg_col, yaxis = "y2")

n1_n2_5_day_call <- list(type = "avg_data", y_column = "N1_N2_5_day", name = "5-day midpoint mean viral signal", short_name = "5-day", color = rolling_avg_col, yaxis = "y2")

n1_n2_7_day_call <- list(type = "avg_data", y_column = "N1_N2_7_day", name = "7-day midpoint mean viral signal", short_name = "7-day", color = rolling_avg_col, yaxis = "y2")

viral_roc_call <- list(type = "avg_data", y_column = "viral_roc_daily", name = "Daily rate of change in viral signal", color = rolling_avg_col, yaxis = "y2")

rolling_avg <- list(type = "avg_data", y_column = "rolling_avg", name = "Daily rate of change in viral signal", color = rolling_avg_col, yaxis = "y2")

viral_rolling_avg_call <- list(type = "avg_data", y_column = "avg_viral_roc_5_day", name = "5-day rolling avg. daily \nchange in viral signal", color = rolling_avg_col, yaxis = "y2")

change_N1_N2_5_day_call <- list(type = "avg_data", y_column = "change_N1_N2_5_day", name = "Percent change in rolling avg \nover 5 days", short_name = "5-day % change", color = rolling_avg_col, yaxis = "y2")

change_N1_N2_10_day_call <- list(type = "avg_data", y_column = "change_N1_N2_10_day", name = "Percent change in rolling avg \nover 10 days", short_name = "10-day % change", color = rolling_avg_col, yaxis = "y2")

change_N1_N2_7_day_call <- list(type = "avg_data", y_column = "change_N1_N2_7_day", name = "Percent change in \nviral signal rolling \navg over 7 days", short_name = "7 day % change", color = rolling_avg_col, yaxis = "y2")

change_new_cases_5_day_call <- list(type = "observed_data", y_column = "change_new_cases_5_day", name = "Percent change in rolling avg \nover 5 days", short_name = "5 day % change", color = case_col, yaxis = "y2", opacity = 0.15)

change_new_cases_10_day_call <- list(type = "observed_data", y_column = "change_new_cases_10_day", name = "Percent change in rolling avg \nover 10 days", short_name = "10 day % change", color = case_col, yaxis = "y2", opacity = 0.15)

change_new_cases_7_day_call <- list(type = "observed_data", y_column = "change_new_cases_7_day", name = "Percent change in \nnew case rolling \navg over 7 days", short_name = "7 day % change", color = case_col, yaxis = "y2", opacity = 0.15)

daily_viral_signal_call <- list(type = "observed_data", y_column = "N1_N2_avg_clean", name = "Daily viral signal", short_name = "Daily signal", color = rolling_avg_col, yaxis = "y2", opacity = 0.50)

daily_viral_signal_call_omit <- list(type = "observed_data", y_column = "N1_N2_avg_omit", name = "Omitted viral signal", short_name = "Daily signal", color = case_col, yaxis = "y2", opacity = 0.50)

var_call <- list(type = "signal_data", y_column = "propB117", name = "% B.1.1.7 RNA", color = case_col)

var_nondetect_call <- list(type = "signal_data", y_column = "propB117_detect", name = "B.1.1.7 non-detection", color = red)
```

The National Capital Region is the first community in Canada to conduct and report daily wastewater readings of SARS-CoV-2 viral signal to help inform its community response in the fight against covid-19, thanks to innovative research from the CHEO Research Institute and the University of Ottawa.

People with covid-19 shed the causative SARS-CoV-2 virus in their stool, regardless of whether they have symptoms, receive a covid-19 test or ever are diagnosed. Thus, in contrast to assessing community covid-19 levels by measuring the number of active cases, which may miss asymptomatic infections as well as be subject to limited test availability, wastewater surveillance consistently captures most of the population with covid-19 given that everyone goes to the washroom. In addition to serving as a valuable confirmatory data source for covid-19 levels, wastewater can also serve as early indicator for possible outbreaks, as described below.

---

# {#ww-visualization}

For mobile users, dragging the plot while in landscape mode will allow you to view current data. Using the display options at the top allows you to modify the view by zooming in and out of the plot.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
reworked_figure(xaxis = "date", yaxis = list(daily_viral_signal_call, daily_viral_signal_call_omit, n1_n2_7_day_call), titles = c(y = "Normalized viral copies*", y2 = "", x = "Date", title = "<b>Covid-19 wastewater viral signal, Ottawa</b>"), data = ott_covid_waste, date_constraint = TRUE, ticks = FALSE, constraint_val = 40)
```

*Midpoint mean viral signal omits dates (coloured in blue) flagged by wastewater researchers with potential data concerns. Data is currently being studied for effects of snow melt and other diluting factors on RNA signal. 

---

## Variants of Concern and Interest (VOC and VOI)

```{r, echo=FALSE, warning=FALSE, message=FALSE}
variant_data <- read.csv(file.path(getwd(), "../../Data/ww_variant_text.csv"))

alphaDetect <- as.logical(variant_data[variant_data$variable == "alphaDetect",2])

alphaLevel <- as.character(variant_data[variant_data$variable == "alphaLevel",2])

alphaPCR <- as.logical(variant_data[variant_data$variable == "alphaPCR",2])

alphaPCRDate <- as.Date(variant_data[variant_data$variable == "alphaPCRDate",2])

alphaAssay <- as.logical(variant_data[variant_data$variable == "alphaAssay",2])

alphaAssayDate <- as.Date(variant_data[variant_data$variable == "alphaAssayDate",2])

alphaSummary1 <- ifelse(alphaDetect == TRUE, paste0(paste0("Alpha (B.1.1.7) detected in ", alphaLevel, " levels, "),
                                                  ifelse(alphaPCR == TRUE, paste0("last reported using qRT-PCR on ", alphaPCRDate), ifelse(alphaAssay == TRUE, paste0("last reported using metagenomic assay on ", alphaAssayDate), ""))))
                                                         
alphaSummary2<- ifelse(alphaAssay == TRUE, paste0(" and metagenomic assay on ", alphaAssayDate, "."), "")

alphaSummary <- paste0(alphaSummary1, alphaSummary2)

deltaDetect <- as.logical(variant_data[variant_data$variable == "deltaDetect",2])

deltaLevel <- as.character(variant_data[variant_data$variable == "deltaLevel",2])

deltaPCR <- as.logical(variant_data[variant_data$variable == "deltaPCR",2])

deltaPCRDate <- as.Date(variant_data[variant_data$variable == "deltaPCRDate",2])

deltaAssay <- as.logical(variant_data[variant_data$variable == "deltaAssay",2])

deltaAssayDate <- as.Date(variant_data[variant_data$variable == "deltaAssayDate",2])

deltaSummary1 <- ifelse(deltaDetect == TRUE, paste0(paste0("Delta (B.1.1.7) detected in ", deltaLevel, " levels, "),
                                                  ifelse(deltaPCR == TRUE, paste0("last reported using qRT-PCR on ", deltaPCRDate), ifelse(deltaAssay == TRUE, paste0("last reported using metagenomic assay on ", deltaAssayDate, "."), ""))))
                                                         
deltaSummary2<- ifelse((deltaPCR == TRUE & deltaAssay == TRUE), paste0(" and metagenomic assay on ", deltaAssayDate, "."), "")

deltaSummary <- paste0(deltaSummary1, deltaSummary2)

otherVOCDetect <- as.logical(variant_data[variant_data$variable == "otherVOCDetect",2])

otherVOCDetails <- as.character(variant_data[variant_data$variable == "otherVOCDetails",2])

otherVOCSummary <- ifelse(otherVOCDetect == TRUE, otherVOCDetails, "No other VOC/VOI were identified above the level of detection of the assay.")

summaryDescription <- as.character(variant_data[variant_data$variable == "summaryDescription",2])

```

### Summary

`r alphaSummary`

`r deltaSummary`

`r otherVOCSummary`

Ottawa wastewater includes two VOC/VOI tests. See methods for more details. See the bottom of the page for detailed report, including the quality control summary.

1. Thrice weekly tests for Alpha (B.1.117) using a qRT-PCR assay. These tests are performed by the uOttawa/CHEO laboratory beginning February 2021.

See plot below, “Proportion of variant, Alpha (B1.1117) RNA in wastewater, Ottawa”.

2. Weekly test for all VOC/VOI using a metagenome assay, also known as the consensus community genome. These tests are performed by the National Microbiology Laboratory, Winnipeg beginning May 2021.

`r summaryDescription`

### Detailed report for overall SARS-CoV-2 signal

Analysis of COVID-19 wastewater RNA viral signal shows that the mean is changing direction. Few more datapoints will show if this becomes a trend.

Predictive values of wastewater viral signal data will not be reported due to limitations and uncertainties at this time with respect to varying fecal shedding periods in patients and unreported active cases in the community.

### Quality control

```{r, echo=FALSE, warning=FALSE, message=FALSE}
standCurve95 <- as.logical(variant_data[variant_data$variable == "standCurve95",2])

standardcurves <- ifelse(standCurve95 == TRUE, "Standard curves R 2 ≥ 0.95.", "Standard curves R 2.")

primerEfficiency <- as.character(variant_data[variant_data$variable == "primerEfficiency",2])

negativeTemplateControls <- as.logical(variant_data[variant_data$variable == "negativeTemplateControls",2])

templateControls <- ifelse(negativeTemplateControls == FALSE, "No template controls are negative.", "Template controls are negative.")
```

- `r standardcurves`

- Primer efficiency between `r primerEfficiency`.

- `r templateControls`

### Detailed VOC/VOI report

```{r, echo=FALSE, warning=FALSE, message=FALSE}
detailedDescription1 <- as.character(variant_data[variant_data$variable == "detailedDescription1",2])

detailedDescription2 <- as.character(variant_data[variant_data$variable == "detailedDescription2",2])

detailedDescription3 <- as.character(variant_data[variant_data$variable == "detailedDescription3",2])

detailedDescription4 <- as.character(variant_data[variant_data$variable == "detailedDescription4",2])

detailedDescription5 <- as.character(variant_data[variant_data$variable == "detailedDescription5",2])

detailedDescription6 <- as.character(variant_data[variant_data$variable == "detailedDescription6",2])
```

`r detailedDescription1`

* `r detailedDescription2`

* `r detailedDescription3`

* `r detailedDescription4`

* `r detailedDescription5`

* `r detailedDescription6`

### Protocol

Tiled amplicon sequencing of SARS-CoV-2 meta-genomes 2(ArticV3) using an Illumina platform. See methods for details.

### Quality control

```{r, echo=FALSE, warning=FALSE, message=FALSE}
ctN1Assay <- variant_data[variant_data$variable == "ctN1Assay",2]

ctN2Assay <- variant_data[variant_data$variable == "ctN2Assay",2]
```

* CDC N1 and N2 RT-qPCR assays yielded Cts of `r ctN1Assay` and `ctN2Assay`, respectively (Cts >35 will result in poor sensitivity).

### Interpretation cautions

The accuracy and thus reliability of SARS-CoV-2 wastewater testing is improving, as scientists understand more of the role of factors such as differences in sewage systems and laboratory protocols. Nonetheless, we recommend caution when interpreting daily and short-term variation in the viral signal. The level of detection for variant tests is unknown at this time but based on preliminary data, is estimated at more than 100 newly diagnosed or active cases. Research is underway to arrive at a more precise estimate sensitivity. Covid-19 wastewater signal is helpful when interpreted alongside other covid-19 surveillance measures, taking into consideration the strengths and limitations of each measure. 

---

Variant testing began late February for B.1.1.7 in the Ottawa wastewater system. The next plot illustrates the proportion of variant B.1.1.7 RNA signal detected in wastewater samples.

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.asp = 0.75}
reworked_figure(xaxis = "date", yaxis = list(var_nondetect_call, var_call), error_bands = TRUE, error_pct = TRUE, error_data = "sd", error_col = case_shade, titles = c(y = "Proportion (%)", y2 = "", x = "Date", title = "<b>Proportion of variant B.1.1.7 RNA signal in wastewater, Ottawa</b>"), data = variant_non_detect, ticks = FALSE)
```

*Shaded area reflect the uncertainty of each B.1.1.7 detection.

---

The next plot illustrates the 7-day midpoint mean in daily covid-19 wastewater viral signal. This number is the average of a week’s readings; today's reading, the previous 3 days, and the subsequent 3 days. Also on the graph are various comparators (e.g. reported daily covid-19 cases, hospitalization census), which can be individually selected by toggling the menu on the right.

---

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.asp = 0.45}
reworked_figure(xaxis = "date", yaxis = list(n1_n2_7_day_call), yaxis2 = list(new_case_7_day_call, new_episode_7_day_call, active_case_call, pct_positivity_call_7_day, hosp_call), titles = c(y = "Normalized viral copies*", y2 = "", x = "Date", title = "<b>7-day mean covid-19 wastewater viral signal, Ottawa</b>"), data = ott_covid_waste, yaxis2_button = TRUE, y2_button_name = "Comparator", height = 300)
```

---

Outbreaks often result in significant increases in the number of covid-19 infection. Wastewater surveillance can help identify, even anticipate such outbreaks; for example, note the 580% increase in signal in mid-July preceding the uptick in covid-19 testing by 3 days in the following plot.

---

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.asp = 0.75}
reworked_figure(xaxis = "date", yaxis = list(change_N1_N2_7_day_call, change_new_cases_7_day_call), titles = c(y = "Percent change (%)", x = "Date", title = "<b>Percent change^ in 7 day rolling average</b>"), data = ott_covid_waste)
```

---

See the [Methods](/model/) page for more information on how the samples were collected, access to the data, and how the plots were created. The plots are currently for research only and presented to the public for discussion.

You can learn more about wastewater epidemiology and its role in covid-19 surveillance on Ottawa Public Health's [website](https://www.ottawapublichealth.ca/en/reports-research-and-statistics/Wastewater_COVID-19_Surveillance.aspx).

## Definitions

\* A 7-day average is generated by averaging the levels from a given day with the three previous and three subsequent days. The average is termed “rolling” as it changes each day.  

\* For new cases, the reported date is the day the test result is reported by the laboratory. Episode date is the approximate date of covid-19 infection estimated from information available: the date of symptom onset, test date, or the reported date.

\* A central question in wastewater epidemiology is determining the proportion of the wastewater that is actually from humans and the proportion that is rain water, snow melt etc. To address this issue, viral copy data is thus normalized using a seasonally stable fecal biomarker; pepper mild mottle virus (PMMoV). See [methods](/model/) for more details.

^ Percent change in 7-day average is calculated by comparing the 7-day average (previous day 1 to 7) with a lagged 7-day average (days 8 to 14).

Data to `r as.character(tail(ott_covid_waste$date, n=1))`
---
title: "Ottawa COVID-19 Projections"
params: 
  lang: "en"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
lang <- params$lang
```

```{r include=FALSE}
##Load localization file
source("../../R/localization.R")
localization_data <- read.csv(file.path(getwd(),"../../Data/Covid Localization - Home Page.csv"))
```

```{r, results='hold', echo=FALSE, comment=NA}

intro<- insert_translation(localization_data, lang, "Intro", c(format(Sys.time(), '%d %B, %Y, %X')))
dt_label_half <- insert_translation(localization_data, lang, "DT_label_half")
dt_label_double <- insert_translation(localization_data, lang, "DT_label_double")
dt_label_no_change <- insert_translation(localization_data, lang, "DT_label_no_change")
more <- insert_translation(localization_data, lang, "more")
fewer <- insert_translation(localization_data, lang, "fewer")
the_same <- insert_translation(localization_data, lang, "the_same")
```
`r intro`

```{r, echo=FALSE, warning=FALSE, message=FALSE}

# libraries
library(plotly)
library(tidyverse)
library(jsonlite)
library(ggplot2)
library(dplyr)
library(tidyr)
library(lubridate)
library(stats)
library(covidseir)

# scripts
source("../../R/lag_replacement.R")
source("../../R/observed_data.R")
source("../../R/data_conversion.R")
source("../../R/hosp_projections.R")
source("../../R/open_ottawa_scripts.R")
source("../../R/plot_case_projections.R")

# Pull JSON objects from OpenOttawa
ottawa_case_data <-
  fromJSON("https://opendata.arcgis.com/datasets/6bfe7832017546e5b30c5cc6a201091b_0/FeatureServer/0/query?where=1%3D1&outFields=Cumulative_Active_Cases_by_Episode_Date,7-day_Average_of_Newly_Reported_cases_by_Reported_Date,Daily_Cases_Linked_to_a_Community_Outbreak_by_Episode_Date,Daily_Cases_Not_Linked_to_an_Outbreak_ie_Sporadic_Cases_by_Episode_Date,Daily_Cases_Linked_to_an_Institutional_Outbreak_by_Episode_Date,Cumulative_Deaths_by_Date_of_Death,_Date,Daily_Cases_by_Reported_Date,Daily_Cases_by_Episode_Date,Cases_Newly_Admitted_to_Hospital,Cases_Currently_in_Hospital,Cases_Currently_in_ICU&outSR=4326&f=json")
ottawa_test_data <-
  fromJSON("https://opendata.arcgis.com/datasets/26c902bf1da44d3d90b099392b544b81_0/FeatureServer/0/query?where=1%3D1&outFields=_Date,Number_of_Tests,Daily_%_Positivity&outSR=4326&f=json")

# data
ott_projections <- read.csv(file.path(getwd(), "../../Data/OPH_projection_estimates.csv"))
ott_observed <- data_creation(ottawa_case_data, ottawa_test_data)[["data"]]
peak_projections <- read.csv(file.path(getwd(), "../../Data/peak_projections.csv"))
TOH_projections <- read.csv(file.path(getwd(),"../../Data/TOH_projection_estimates.csv"))
TOH_observed <- read.csv(file.path(getwd(),"../../Data/Observed data/TOH_Observed_Hospital_Use.csv"))

# Save ott_observed as csv
write.csv(ott_observed, "../../Data/Observed data/OPH_Observed_COVID_Data.csv")

## Observed census
exp_census <- calc_expected_values_for_n_weeks(data = ott_observed, number_weeks = 3, first_day = 1)

## Dt = doubling (or halving) time
Dt_census <- exp_census[[2]][[3]]

if(Dt_census == Inf) {
  Dt_census <- 0
}

Dt_label_census = switch( 
  (sign(Dt_census) + 2),
  dt_label_half,
  dt_label_no_change,
  dt_label_double)

more_less_census = switch(
  (sign(Dt_census) + 2),
  fewer,
  the_same,
  more
)

## Observed active cases
exp_active_cases <- calc_expected_values_for_n_weeks(data = ott_observed,
                                                     number_weeks = 3,
                                                     observed_columns_name = "observed_active_cases",
                                                     first_day = 1)

## Dt = doubling (or halving) time
Dt_active_cases <- exp_active_cases[[2]][[3]]

if(Dt_active_cases == Inf) {
  Dt_active_cases <- 0
}

Dt_label_active_cases = switch( 
  (sign(Dt_active_cases) + 2),
  dt_label_half,
  dt_label_no_change,
  dt_label_double)

more_less_active_cases = switch(
  (sign(Dt_active_cases) + 2),
  fewer,
  the_same,
  more
)

## projections
peak_projections$intervention <-
  factor(peak_projections$intervention, levels = c("Current transmission", "10% increase in transmission", "Early outbreak transmission"))

# Values from peak_projections.csv
current <- peak_projections[1,2] # peak with current distancing
reduction_20 <- peak_projections[2,2] # peak with 20% decrease in distancing
reduction_100 <- peak_projections[3,2] # peak with no distancing (pre-covid distancing)

current_date <- peak_projections[1,4] # date of peak with current distancing
reduction_20_date <- peak_projections[2,4] # date of peak with 20% reduction of distancing
reduction_100_date <- peak_projections[3,4] # date of peak with no distancing


# Colors
acute_col <- "rgb(72, 137, 194)"
acute_shade <- "rgba(72, 137, 194, 0.3)"
acute_hex <- "#488AC2"

vent_col <- "rgb(23, 63, 95)"
vent_shade <- "rgba(23, 63, 95, 0.3)"

icu_col <- "rgb(60, 174, 163)"
icu_shade <- "rgba(60, 174, 163)"

current_case_col <- "rgb(0, 128, 128)"
current_case_shade <- "rgba(0, 128, 128)"
current_case_hex <- "#008080"

increase_col <- "rgb(246, 213, 86)"
increase_shade <- "rgba(246, 213, 86)"
increase_hex <- "#F6D556"

reduction_col <- "rgb(133, 194, 43)"
reduction_shade <- "rgba(133, 194, 43)"
reduction_hex <- "#85c22b"
```

```{r, results='hold', echo=FALSE, comment=NA}
line_break <- insert_translation(localization_data, lang, "break")
dashboard <- insert_translation(localization_data, lang, "Dashboard",
                                c(as.character(tail(ott_observed$date, n=1)),
                                  last(na.omit(ott_observed$observed_active_cases)),
                                  last(na.omit(ott_observed$observed_census_ICU_p_acute_care)),
                                  last(na.omit(ott_observed$observed_census_acute_care)),
                                  last(na.omit(ott_observed$observed_census_ICU))))

definitions <- insert_translation(localization_data, lang, "Definitions")

short_range_forecast <- insert_translation(localization_data, lang, "ShortRangeForecast", 
                                           c(more_less_active_cases,
                                             Dt_label_active_cases,
                                             round(abs(exp_active_cases[[2]][[3]]), 0),
                                             round(100*exp_active_cases[[4]][[3]], 0),
                                             more_less_census,
                                             Dt_label_census,
                                             round(abs(exp_census[[2]][[3]]), 0),
                                             round(100*exp_census[[4]][[3]], 0)))

long_range_forecast <- insert_translation(localization_data, lang, "LongRangeForecast",
                                          c(current,
                                            reduction_20,
                                            paste(current_date),
                                            paste(reduction_20_date))
                                            )

defintions <- insert_translation(localization_data, lang, "Definitions")

past_hospital_use <- insert_translation(localization_data, lang, "PastHospital_title") 

past_hospital_text <- insert_translation(localization_data, lang, "PastHospital_text",
                                         c(Dt_label,
                                           round(abs(exp_census[[2]][[3]]), 0),
                                           round(effective_pd, 0))) 

observed_admits <- insert_translation(localization_data, lang, "observed_admits")

projected_hospital_title <- insert_translation(localization_data, lang, "ProjectedHospital_title")

projected_hospital_text <- insert_translation(localization_data, lang, "ProjectedHospital_text", 
                                              c(signif(current, 2),
                                                paste(current_date),
                                                round(100*exp_census[[4]][[3]], 0),
                                                signif(reduction_20, 2),
                                                paste(reduction_20_date),
                                                signif(reduction_100, 2),
                                                paste(reduction_100_date)))

hosp_projections <- insert_translation(localization_data, lang, "hosp_projections")

vent_projections <- insert_translation(localization_data, lang, "vent_projections")

death_title <- insert_translation(localization_data, lang, "death_title")

death_text <- insert_translation(localization_data, lang, "Death_text") 
```

`r dashboard`

`r short_range_forecast`

`r long_range_forecast`

`r definitions`

`r past_hospital_use`

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Ottawa Hospital data section @Warsame
exp_census[[1]]$DT1 <- exp_census[[3]][[1]]$expected_val
exp_census[[1]]$DT2 <- exp_census[[3]][[2]]$expected_val
exp_census[[1]]$DT3 <- exp_census[[3]][[3]]$expected_val

#Old depricated call
#observed_figure(exp_census, "Observed census of COVID-19 hospitalizations in Ottawa", "Census (# of patients)")

# Graph selection list
icu_call <- list(type = "observed_data", y_column = "observed_census_ICU", name = "ICU census", color = icu_col)
acute_care <- list(type = "observed_data", y_column = "observed_census_acute_care", name = "Acute care census", color = acute_col)

# Plotly creation 
ottawa_hosp <-
  reworked_figure(
    xaxis = "date",
    yaxis = list(icu_call, acute_care), #DT1, DT2, DT3),
    titles = c(y = "# of patients", x = "Date", title = "Observed census of COVID-19 hospitalizations in Ottawa hospitals"),
    data = exp_census[[1]]
  )

# Display graph
ottawa_hosp
```

`r past_hospital_text`

`r line_break`

`r observed_admits`


```{r, echo=FALSE, warning=FALSE, message=FALSE}
observed_daily_ICU_p_acute_care <- list(type = "observed_data", y_column = "observed_new_ICU_p_acute_care", name = "Reported # of patients", color = acute_col)



ICU_p_acute_care <-
  reworked_figure(
    xaxis = "date",
    yaxis = list(observed_daily_ICU_p_acute_care),
    titles = c(y = "# of patients", x = "Date", title = "Observed new COVID-19 hospitalizations in Ottawa"),
    data = ott_observed
  )

ICU_p_acute_care

```

`r line_break`

`r hosp_projections`

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../../R/hosp_projections.R")
hosp_fun(ott_projections, "hosp_census", title = "Projected COVID-19 hospital census in Ottawa", y = "Census (# of patients)", current_color = acute_col, current_shade = acute_shade, reduction_value = 10, reduction_color = reduction_col, reduction_shade = reduction_shade, increase_value = 10, increase_color = increase_col, increase_shade = increase_shade, observed_name = "Observed census of patients", project_to = "2020-12-31")
```

`r line_break`

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../../R/hosp_projections.R")
hosp_fun(ott_projections, "hosp_admits", title = "Projected COVID-19 daily hospital admissions in Ottawa", y = "New admissions (# of patients)", current_color = acute_col, current_shade = acute_shade, reduction_value = 10, reduction_color = reduction_col, reduction_shade = reduction_shade, increase_value = 10, increase_color = increase_col, increase_shade = increase_shade, observed_name = "Observed # of daily admissions", project_to = "2020-12-31")
```

`r line_break`
---
title: "epinow-hosp-ww-assessment"
author: "Warsame Yusuf"
date: "15/12/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load}
# load library, packages, functions
library(EpiNow2)
library(tidyverse)
library(plotly)
library(ggplot2)
library(dplyr)
library(tidyr)
library(lubridate)
library(stats)
library(zoo)
library(stringr)
library(RColorBrewer)

source("../R/epinow_functions.R")
source("../R/open_ottawa_scripts.R")
source("../R/wastewater.R")

# load covid & ww data
ott_covid_data <-
  read.csv(file.path(getwd(), "../Data/Observed Data/OPH_Observed_COVID_Data.csv"))

ott_observed_waste <- read.csv("https://raw.githubusercontent.com/Big-Life-Lab/covid-19-wastewater/main/data/wastewater_virus.csv")
waste_clean <- wastewater_prep(ott_observed_waste)

# Set reporting delay, generation time, incubation period
reporting_delay <- bootstrapped_dist_fit(rlnorm(100, log(4), 1), max_value = 30)
generation_time <-
  get_generation_time(disease = "SARS-CoV-2", source = "ganyani")
incubation_period <-
  get_incubation_period(disease = "SARS-CoV-2", source = "lauer")
```

## Short term hospitalizations
```{r}
# set number of cores to use fitting the model
# no benefit on runtime if cores > chains which is set to 4 by default
options(mc.cores = 4)

# Create vector of time frame in weeks
time_frame <- c(12, 24, 36, 48)
```

```{r}
# Run a for loop for short term projections based on various time frames
plots <- list()
x <- 0 
for(i in time_frame){
  x <- x + 1
  # Prep existing data
hosp_data <- ott_covid_data %>%
  select(date, observed_new_cases, observed_census_ICU_p_acute_care) %>%
  mutate(date = as.Date(date)) %>%
  rename(primary = "observed_new_cases", secondary = "observed_census_ICU_p_acute_care") %>%
  filter(date >= (max(as.Date(date)) - i*7))

# Create training and testing data
train_data <- hosp_data %>%
  filter(date < (max(as.Date(date)) - 7*2))

test_data <- hosp_data %>%
  filter(date >= (max(as.Date(date)) - 7*2))

train_data <- data.table::setDT(train_data)
test_data <- data.table::setDT(test_data)

# Estimate relationship between cases and hospitalization
cases_to_hosp <- estimate_secondary(train_data, 
                                    delays = delay_opts(list(mean = 2.5, mean_sd = 0.2, 
                                                               sd = 0.47, sd_sd = 0.1, max = 21)),
                                    secondary = secondary_opts(type = "prevalence"),
                                    obs = obs_opts(scale = list(mean = 0.01, sd = 0.0025)),
                                    control = list(adapt_delta = 0.95))

# Forecast hospitalizations using case data
case_forecast <- epinow(reported_cases = copy(train_data)[, .(date, confirm = primary)], 
                        generation_time = generation_time,
                        delays = delay_opts(incubation_period, reporting_delay),
                        rt = rt_opts(prior = list(mean = 1.5, sd = 0.5), rw = 7),
                        gp = NULL, horizon = 21)

hosp_forecast <- forecast_secondary(cases_to_hosp, case_forecast$estimates)

# Prep data to be visualized
hosp_proj <- hosp_forecast[[2]]

hosp_proj$variable <- "reported_cases"

hosp_proj$type <- ifelse(hosp_proj$date <= max(ott_covid_data$date), "estimate", "forecast")

# Plot forecasted data
plot <- short_term_plot(projections = hosp_proj, obs_data = ott_covid_data, obs_column = "observed_census_ICU_p_acute_care", forecast_type = "reported_cases", ylab = "Hospital census", title = paste(paste("Hospital census projections for", i, sep = " "), "weeks", sep = " "))

plots[[x]] <- plot
}

save(plots, "plots.RData")
```

## Wastewater
```{r}

```